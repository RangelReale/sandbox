--
-- poco.lua
--
-- Premake build script for POCO library (Foundation)
--
-- Copyright (c) 2004-2008, Applied Informatics Software Engineering GmbH.
-- and Contributors.
--
-- Permission is hereby granted, free of charge, to any person or organization
-- obtaining a copy of the software and accompanying documentation covered by
-- this license (the "Software") to use, reproduce, display, distribute,
-- execute, and transmit the Software, and to prepare derivative works of the
-- Software, and to permit third-parties to whom the Software is furnished to
-- do so, all subject to the following:
--
-- The copyright notices in the Software and this entire statement, including
-- the above license grant, this restriction and the following disclaimer,
-- must be included in all copies of the Software, in whole or in part, and
-- all derivative works of the Software, unless such copies or derivative
-- works are solely in the form of machine-executable object code generated by
-- a source language processor.
--
-- THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
-- IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
-- FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
-- SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
-- FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
-- ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
-- DEALINGS IN THE SOFTWARE.
--

package.language = "c++"
package.objdir = "obj/poco"

package.name = "Foundation"

-- if (options["target"] == "vs6") then
--     package.name = "Foundation".."_vs6"
-- elseif (options["target"] == "vs2003") then
--     package.name = "Foundation".."_vs71"
-- elseif (options["target"] == "vs2005") then
--     package.name = "Foundation".."_vs80"
-- elseif (options["target"] == "vs2005") then
--     package.name = "Foundation".."_vs90"
-- else 
--     package.name = "Foundation"
-- end

for k,v in ipairs(project.configs) do
    package.config[v].target=package.config[v].name
end

-- Append a "d" to the debug version of the libraries
package.config["debug_shared"].target= "Poco" ..package.name .."d"
package.config["release_shared"].target= "Poco" ..package.name
package.config["debug_static"].target= "Poco" ..package.name .. "mtd"
package.config["release_static"].target= "Poco" ..package.name .. "mt"

-- Define _DEBUG/NDEBUG depending on build kind

for k,v in ipairs(project.configs) do
    if (string.find(v, "debug") ~= nil) then
        table.insert(package.config[v].defines, "_DEBUG")
    else
        -- Allow asserts to be included in release build by default
        --      table.insert(package.config[v].defines, "NDEBUG")
    end
end


-- Output is placed in a directory named for the target toolset.
package.path = options["target"]

-- Package Build Settings

if (not options["enable-shared-only"]) then

    package.config["debug_static"].kind = "lib"
    package.config["release_static"].kind = "lib"
    table.insert(package.config["debug_static"].defines, "Foundation_EXPORTS")
    table.insert(package.config["debug_static"].defines, "POCO_STATIC")
    table.insert(package.config["debug_static"].defines, "PCRE_STATIC")
    table.insert(package.config["release_static"].defines, "Foundation_EXPORTS")
    table.insert(package.config["release_static"].defines, "POCO_STATIC")
    table.insert(package.config["release_static"].defines, "PCRE_STATIC")

end

if (not options["enable-static-only"]) then

    package.config["debug_shared"].kind = "dll"
    package.config["release_shared"].kind = "dll"
    table.insert(package.config["debug_shared"].defines, "_USRDLL")
    table.insert(package.config["debug_shared"].defines, "Foundation_EXPORTS")
    table.insert(package.config["debug_shared"].defines, "PCRE_STATIC")
    table.insert(package.config["release_shared"].defines, "_USRDLL")
    table.insert(package.config["release_shared"].defines, "Foundation_EXPORTS")
    table.insert(package.config["release_shared"].defines, "PCRE_STATIC")

end


package.includepaths =
{
    "../../Foundation/include"
}

if (windows) then
    table.insert(package.defines, "WIN32")
    table.insert(package.defines, "_WINDOWS")
end

-- disable VS2005 CRT security warnings
if (options["target"] == "vs2005" or options["target"] == "vs2008") then
    table.insert(package.defines, "_CRT_SECURE_NO_DEPRECATE")
end


-- Build Flags

package.config["debug_static"].buildflags   = { }
package.config["debug_shared"].buildflags   = { }

package.config["release_shared"].buildflags = { "optimize-speed", "no-symbols", "no-frame-pointer" }
package.config["release_static"].buildflags = { "optimize-speed", "no-symbols", "no-frame-pointer" }


-- Libraries

if (windows) then
    -- table.insert(package.links, "iphlpapi.lib")
end

if (linux) then
    table.insert(package.links, "pthread")
end


-- Files

Excluded_files =
{
    matchrecursive("../../Foundation/src/*_*.cpp"),
}

WIN32_Files =
{
    "../../Foundation/src/Mutex_WIN32.cpp"
}

POSIX_Files =
{
    "../../Foundation/src/Mutex_POSIX.cpp"
}

VMS_Files =
{
}

Core_files =
{
    -- Add the include files recursively 
    matchrecursive("../../Foundation/include/*.h"),
    matchrecursive("../../Foundation/include/*.cpp"),

    -- Add the source recursively 
    matchrecursive("../../Foundation/src/*.cpp")
}

if (windows) then
    table.insert(package.defines, "WIN32")
    table.insert(package.defines, "_WINDOWS")

    table.insert(package.excludes, POSIX_Files)
    table.insert(package.excludes, VMS_Files)

    -- Remove platform-dependent cpp include file
    -- They are not supposed to be add to build list by POCO
    for v in ipairs(Core_files) do
        if (string.find(v, "_") ~= nil) then
            v = nil
        end
    end

end

if (not windows) then
    table.insert(package.excludes, WIN32_Files)
end

package.files = { Core_files }
package.excludes = { Excluded_files }

